#!/bin/bash

# ============================================================================
# ะกะบัะธะฟั ะดะตะฟะปะพั ะฟัะธะปะพะถะตะฝะธั sgiprealestate.com
# ะัะทัะฒะฐะตั deploy-smart.sh ะฝะฐ ะฟัะพะด ัะตัะฒะตัะต ัะตัะตะท nginx-microservice
# ะะฐะฟััะบะฐะตััั ะฝะตะฟะพััะตะดััะฒะตะฝะฝะพ ะฝะฐ ะฟัะพะด ัะตัะฒะตัะต
# ============================================================================

set -e

# ะะพะฝัะธะณััะฐัะธั
SERVICE_NAME="${SERVICE_NAME:-sgiprealestate-service}"
NGINX_MICROSERVICE_PATH="${NGINX_MICROSERVICE_PATH:-/home/alfares/nginx-microservice}"
DEPLOY_SCRIPT_PATH="$NGINX_MICROSERVICE_PATH/scripts/blue-green/deploy-smart.sh"

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ะคัะฝะบัะธั ะดะปั ะฒัะฒะพะดะฐ ัะพะพะฑัะตะฝะธะน
info() {
    echo -e "${BLUE}โน๏ธ  $1${NC}"
}

success() {
    echo -e "${GREEN}โ $1${NC}"
}

warning() {
    echo -e "${YELLOW}โ๏ธ  $1${NC}"
}

error() {
    echo -e "${RED}โ $1${NC}"
}

# ะัะพะฒะตัะบะฐ ะฐัะณัะผะตะฝัะพะฒ
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./deploy.sh [SERVICE_NAME]"
    echo ""
    echo "ะะฐัะฐะผะตััั:"
    echo "  SERVICE_NAME    ะะผั ัะตัะฒะธัะฐ ะดะปั ะดะตะฟะปะพั (ะฟะพ ัะผะพะปัะฐะฝะธั: sgiprealestate-service)"
    echo ""
    echo "ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั:"
    echo "  SERVICE_NAME            ะะผั ัะตัะฒะธัะฐ (ะธะผะตะตั ะฟัะธะพัะธัะตั ะฝะฐะด ะฐัะณัะผะตะฝัะพะผ)"
    echo "  NGINX_MICROSERVICE_PATH ะััั ะบ nginx-microservice (ะฟะพ ัะผะพะปัะฐะฝะธั: /home/alfares/nginx-microservice)"
    echo ""
    echo "ะัะธะผะตัั:"
    echo "  ./deploy.sh"
    echo "  ./deploy.sh sgiprealestate-service"
    echo "  SERVICE_NAME=my-service ./deploy.sh"
    exit 0
fi

# ะัะปะธ ะฟะตัะตะดะฐะฝ ะฐัะณัะผะตะฝั, ะธัะฟะพะปัะทะพะฒะฐัั ะตะณะพ ะบะฐะบ ะธะผั ัะตัะฒะธัะฐ
# (ะฟะตัะตะผะตะฝะฝะฐั ะพะบััะถะตะฝะธั ะธะผะตะตั ะฟัะธะพัะธัะตั, ะฟะพััะพะผั ะฟัะพะฒะตััะตะผ ะตั ะฟะตัะฒะพะน)
if [ -n "$1" ] && [ -z "${SERVICE_NAME}" ]; then
    SERVICE_NAME="$1"
fi

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ              ๐ ะะะะะะ ะะะะะะะะะะฏ                            โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
info "ะกะตัะฒะธั: $SERVICE_NAME"
info "ะกะบัะธะฟั ะดะตะฟะปะพั: $DEPLOY_SCRIPT_PATH"
echo ""

# ะัะพะฒะตัะบะฐ ะดะพัััะฟะฐ ะบ ะดะธัะตะบัะพัะธะธ nginx-microservice
info "ะัะพะฒะตัะบะฐ ะดะพัััะฟะฐ ะบ nginx-microservice..."
if [ ! -r "$NGINX_MICROSERVICE_PATH" ] 2>/dev/null; then
    error "ะะตั ะดะพัััะฟะฐ ะบ ะดะธัะตะบัะพัะธะธ: $NGINX_MICROSERVICE_PATH"
    echo ""
    warning "ะัะพะฑะปะตะผะฐ ั ะฟัะฐะฒะฐะผะธ ะดะพัััะฟะฐ. ะะพะทะผะพะถะฝัะต ะฟัะธัะธะฝั:"
    echo "  1. ะะพะดะธัะตะปััะบะฐั ะดะธัะตะบัะพัะธั /home/alfares ะธะผะตะตั ะฟัะฐะฒะฐ drwxr-x---"
    echo "  2. ะะต ัััะฐะฝะพะฒะปะตะฝั ะฟัะฐะฒะฐ ะฝะฐ nginx-microservice"
    echo ""
    info "ะะปั ัะตัะตะฝะธั ะฒัะฟะพะปะฝะธัะต ะฝะฐ ัะตัะฒะตัะต:"
    echo ""
    echo "  # ะัะปะธ /home/alfares ะฑะปะพะบะธััะตั ะดะพัััะฟ:"
    echo "  sudo chgrp deployers /home/alfares"
    echo "  sudo chmod 775 /home/alfares"
    echo ""
    echo "  # ะะฐัััะพะนะบะฐ ะฟัะฐะฒ ะฝะฐ nginx-microservice:"
    echo "  sudo chgrp -R deployers $NGINX_MICROSERVICE_PATH"
    echo "  sudo chmod -R 775 $NGINX_MICROSERVICE_PATH"
    echo "  sudo chmod g+s $NGINX_MICROSERVICE_PATH"
    echo ""
    info "ะะพัะปะต ะฝะฐัััะพะนะบะธ ะฟะตัะตะปะพะณะธะฝััะตัั: exit && ssh alfares"
    exit 1
fi
success "ะะพัััะฟ ะบ ะดะธัะตะบัะพัะธะธ ะตััั"

# ะัะพะฒะตัะบะฐ ัััะตััะฒะพะฒะฐะฝะธั ัะบัะธะฟัะฐ ะดะตะฟะปะพั
info "ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ัะบัะธะฟัะฐ ะดะตะฟะปะพั..."
if [ ! -f "$DEPLOY_SCRIPT_PATH" ]; then
    error "ะกะบัะธะฟั ะดะตะฟะปะพั ะฝะต ะฝะฐะนะดะตะฝ: $DEPLOY_SCRIPT_PATH"
    error "ะฃะฑะตะดะธัะตัั, ััะพ nginx-microservice ัััะฐะฝะพะฒะปะตะฝ ะธ ะฝะฐัััะพะตะฝ"
    echo ""
    info "ะัะพะฒะตัััะต ะฟััั ะธะปะธ ัะบะฐะถะธัะต ัะตัะตะท ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั:"
    echo "  NGINX_MICROSERVICE_PATH=/path/to/nginx-microservice ./scripts/deploy.sh"
    exit 1
fi
success "ะกะบัะธะฟั ะดะตะฟะปะพั ะฝะฐะนะดะตะฝ"

# ะัะพะฒะตัะบะฐ ะฟัะฐะฒ ะฝะฐ ะฒัะฟะพะปะฝะตะฝะธะต
info "ะัะพะฒะตัะบะฐ ะฟัะฐะฒ ะฝะฐ ะฒัะฟะพะปะฝะตะฝะธะต..."
if [ ! -x "$DEPLOY_SCRIPT_PATH" ]; then
    warning "ะกะบัะธะฟั ะฝะต ะธะผะตะตั ะฟัะฐะฒ ะฝะฐ ะฒัะฟะพะปะฝะตะฝะธะต, ะฟััะฐะตะผัั ะธัะฟัะฐะฒะธัั..."
    if chmod +x "$DEPLOY_SCRIPT_PATH" 2>/dev/null; then
        success "ะัะฐะฒะฐ ะฝะฐ ะฒัะฟะพะปะฝะตะฝะธะต ัััะฐะฝะพะฒะปะตะฝั"
    else
        error "ะะต ัะดะฐะปะพัั ัััะฐะฝะพะฒะธัั ะฟัะฐะฒะฐ ะฝะฐ ะฒัะฟะพะปะฝะตะฝะธะต"
        error "ะัะถะฝะฐ ะฝะฐัััะพะนะบะฐ ะณััะฟะฟั deployers (ัะผ. ะธะฝััััะบัะธั ะฒััะต)"
        exit 1
    fi
else
    success "ะัะฐะฒะฐ ะฝะฐ ะฒัะฟะพะปะฝะตะฝะธะต ัััะฐะฝะพะฒะปะตะฝั"
fi

echo ""
info "ะะฐะฟััะบ ะดะตะฟะปะพั..."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

# ะัะฟะพะปะฝะตะฝะธะต ะดะตะฟะปะพั
cd "$NGINX_MICROSERVICE_PATH/scripts/blue-green"
./deploy-smart.sh "$SERVICE_NAME"

DEPLOY_EXIT_CODE=$?

echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if [ $DEPLOY_EXIT_CODE -eq 0 ]; then
    success "ะะตะฟะปะพะน ััะฟะตัะฝะพ ะทะฐะฒะตััะตะฝ!"
    echo ""
    info "ะัะพะฒะตัััะต ััะฐััั ัะตัะฒะธัะฐ:"
    echo "   docker ps | grep $SERVICE_NAME"
else
    error "ะะตะฟะปะพะน ะทะฐะฒะตััะธะปัั ั ะพัะธะฑะบะพะน (ะบะพะด: $DEPLOY_EXIT_CODE)"
    echo ""
    warning "ะัะพะฒะตัััะต ะปะพะณะธ ะฝะฐ ัะตัะฒะตัะต ะดะปั ะดะตัะฐะปะตะน"
    exit $DEPLOY_EXIT_CODE
fi
